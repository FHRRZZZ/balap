<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kuis Balapan Mobil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .car-icon {
      position: absolute;
      top: 50%;
      transform: translateY(-50%) scaleX(-1);
      transition: right 600ms ease;
      font-size: 32px;
      right: 0;
    }
  </style>
</head>
<body class="bg-yellow-50 flex flex-col items-center justify-center min-h-screen">

  <!-- Judul -->
  <h1 class="text-3xl font-bold mb-4 text-yellow-700">üèÅ Kuis Balapan Mobil</h1>

  <!-- Area lintasan -->
  <div id="track" class="w-full max-w-3xl bg-gray-200 h-24 rounded-lg relative overflow-hidden mb-4"></div>

  <!-- Area soal -->
  <div id="quizArea" class="bg-white rounded-lg shadow-lg p-4 text-center w-80">
    <p id="questionText" class="text-lg font-semibold mb-2">Soal akan muncul di sini</p>
    <input id="answerInput" type="number" class="border rounded p-2 w-full mb-3" placeholder="Jawaban kamu..." />
    <button id="submitBtn" class="bg-yellow-600 text-white px-4 py-2 rounded w-full">Jawab</button>
  </div>

  <!-- Modal skor -->
  <div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-6 text-center max-w-sm w-full">
      <h2 class="text-xl font-bold text-gray-800 mb-2">üéâ Kuis Selesai!</h2>
      <p class="text-gray-700 mb-4" id="scoreText">Skor kamu: 0</p>
      <button id="retryBtn" class="bg-yellow-600 text-white px-4 py-2 rounded">Coba Lagi</button>
    </div>
  </div>

  <script type="module">
    // Import Firebase modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";

    // üî• Konfigurasi Firebase kamu
    const firebaseConfig = {
      apiKey: "AIzaSyAfHIXrnD9iFZx03ASospR-INapp6ImjUM",
      authDomain: "balap-50624.firebaseapp.com",
      databaseURL: "https://balap-50624-default-rtdb.firebaseio.com",
      projectId: "balap-50624",
      storageBucket: "balap-50624.firebasestorage.app",
      messagingSenderId: "650447642185",
      appId: "1:650447642185:web:bb6007a2e68e633fcbe998",
      measurementId: "G-4NT9V14N92"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // üß© Konstanta permainan
    const QUESTIONS_PER_GAME = 5;
    const POINTS_PER_CORRECT = 1;

    let playerId = "player_" + Math.floor(Math.random() * 9999);
    let roomId = "room1";

    // üßÆ Fungsi buat soal acak
    function genQuestion() {
      const a = Math.floor(Math.random() * 9) + 1;
      const b = Math.floor(Math.random() * 9) + 1;
      return { q: `${a} + ${b} = ?`, a: a + b };
    }

    // üöó Konversi skor ke posisi mobil (kanan ke kiri)
    function scoreToPercent(score) {
      const max = QUESTIONS_PER_GAME;
      const pct = Math.min(92, Math.round((score / max) * 92));
      return (92 - pct) + "%"; // makin besar skor, makin ke kiri
    }

    // üöó Render semua mobil di lintasan
    async function renderTrack() {
      const snap = await get(ref(db, `rooms/${roomId}/players`));
      const track = document.getElementById("track");
      track.innerHTML = "";

      if (snap.exists()) {
        const players = snap.val();
        Object.entries(players).forEach(([id, p]) => {
          const car = document.createElement("div");
          car.className = "car-icon";
          car.style.right = scoreToPercent(p.score || 0);
          car.textContent = "üöóüí®";
          track.appendChild(car);
        });
      }
    }

    // üé≤ Tampilkan soal sekarang
    async function showQuestion() {
      const qSnap = await get(ref(db, `rooms/${roomId}/currentQuestion`));
      if (qSnap.exists()) {
        document.getElementById("questionText").textContent = qSnap.val().q;
      }
    }

    // üöÄ Submit jawaban pemain
    async function submitAnswer() {
      const val = document.getElementById("answerInput").value.trim();
      if (val === "") return alert("Masukkan jawaban!");
      const qSnap = await get(ref(db, `rooms/${roomId}/currentQuestion`));
      if (!qSnap.exists()) return;

      const current = qSnap.val();
      const numeric = Number(val);
      const playerRef = ref(db, `rooms/${roomId}/players/${playerId}`);

      if (numeric === current.a) {
        await runTransaction(ref(db, `${playerRef.path.pieces_.join('/')}/score`), (cur) => (cur || 0) + POINTS_PER_CORRECT);
        await runTransaction(ref(db, `${playerRef.path.pieces_.join('/')}/questionIndex`), (cur) => (cur || 0) + 1);

        const playerSnap = await get(playerRef);
        const playerData = playerSnap.val();

        if (playerData.questionIndex >= QUESTIONS_PER_GAME) {
          showScoreModal(playerData.score);
          return;
        }

        const nq = genQuestion();
        await set(ref(db, `rooms/${roomId}/currentQuestion`), nq);
      } else {
        alert("Salah, coba lagi!");
      }

      document.getElementById("answerInput").value = "";
    }

    // ü™ü Tampilkan popup skor
    function showScoreModal(score) {
      const modal = document.getElementById("scoreModal");
      document.getElementById("scoreText").textContent = `Skor kamu: ${score}/${QUESTIONS_PER_GAME}`;
      modal.classList.remove("hidden");
      modal.classList.add("flex");

      document.getElementById("retryBtn").onclick = async () => {
        await update(ref(db, `rooms/${roomId}/players/${playerId}`), {
          score: 0,
          questionIndex: 0
        });
        modal.classList.add("hidden");

        const nq = genQuestion();
        await set(ref(db, `rooms/${roomId}/currentQuestion`), nq);
      };
    }

    // üö¶ Inisialisasi game
    async function init() {
      // Batasi max 5 pemain
      const playersSnap = await get(ref(db, `rooms/${roomId}/players`));
      if (playersSnap.exists() && Object.keys(playersSnap.val()).length >= 5) {
        alert("Room sudah penuh (maksimal 5 pemain)");
        return;
      }

      await set(ref(db, `rooms/${roomId}/players/${playerId}`), {
        name: playerId,
        score: 0,
        questionIndex: 0
      });

      const nq = genQuestion();
      await set(ref(db, `rooms/${roomId}/currentQuestion`), nq);

      onValue(ref(db, `rooms/${roomId}/players`), renderTrack);
      onValue(ref(db, `rooms/${roomId}/currentQuestion`), showQuestion);
    }

    // Tombol event
    document.getElementById("submitBtn").addEventListener("click", submitAnswer);
    init();
  </script>
</body>
</html>
